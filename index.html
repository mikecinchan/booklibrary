<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book Library (Private)</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --text-dim:#9ca3af;
         --accent:#22c55e; --accent-2:#3b82f6; --danger:#ef4444; --ring:#22c55e33; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
       background:linear-gradient(180deg,var(--bg),#0b1023);color:#e5e7eb;-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .title{font-size:clamp(20px,3vw,28px);font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
  .badge{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .panel{background:linear-gradient(180deg,var(--panel),#0e162e);border:1px solid #1f2a44;border-radius:var(--radius);box-shadow:0 10px 30px #0008,inset 0 1px 0 #ffffff14}

  .controls{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
  .controls-row{display:grid;grid-template-columns:1fr minmax(140px,200px);gap:12px}
  @media (min-width:720px){.controls{grid-template-columns:1fr auto auto;align-items:center}.controls-row{grid-template-columns:1fr 200px}}
  .searchbar{position:relative}
  .searchbar input{width:100%;padding:12px 40px;border-radius:12px;background:var(--muted);border:1px solid #26324d;color:#e5e7eb;outline:none}
  .searchbar input:focus{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .searchbar .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7;font-size:18px}
  select,button,input[type="email"],input[type="password"]{height:44px;border-radius:12px;border:1px solid #26324d;background:var(--muted);color:#e5e7eb;padding:0 12px;outline:none}
  select:focus,button:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:0 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#12a150);border-color:#1a7c45}
  .btn.ghost{background:transparent}
  .btn.small{height:36px;border-radius:10px;padding:0 10px;font-size:14px}

  .form{padding:16px;display:grid;gap:12px}
  .grid-2{display:grid;gap:12px;grid-template-columns:1fr}
  @media (min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
  .field{display:grid;gap:6px}
  label{font-size:12px;color:var(--text-dim);letter-spacing:.3px}
  input,.form select{width:100%;height:44px;border-radius:10px;padding:10px 12px;background:#0e1428;border:1px solid #243356;color:#e5e7eb}
  input::placeholder{color:#6b7280}

  .list{padding:12px;display:grid;gap:12px}
  .empty{border:1px dashed #2a3a64;border-radius:12px;padding:24px;text-align:center;color:#94a3b8}
  .card{display:grid;gap:8px;padding:14px;border:1px solid #233354;border-radius:14px;background:linear-gradient(180deg,#0f1a33,#0d152b)}
  @media (min-width:700px){.card{grid-template-columns:1fr auto;align-items:center}}
  .meta{display:grid;gap:4px}
  .title-row{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
  .book-title{font-weight:800;letter-spacing:.2px}
  .muted{color:#9ca3af;font-size:14px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#122044;border:1px solid #223056;color:#c7d2fe}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .footer-note{color:#94a3b8;font-size:12px;text-align:center;padding:8px 0}

  /* pager */
  .pager{display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
  .pager .btn[disabled]{opacity:.5;cursor:not-allowed}

  /* login */
  .center{min-height:60vh;display:grid;place-items:center}
  .login-card{max-width:420px;width:100%;padding:18px;border-radius:16px}
  .msg{margin-top:10px;display:none}
  .error{background:#7f1d1d;color:#fff;border-radius:10px;padding:8px 10px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">üìö Book Library <span class="badge">Private</span></div>
      <div class="muted">Sign in to access. (Email/Password)</div>
    </header>

    <!-- LOGIN PAGE -->
    <section id="loginPage" class="center">
      <div class="panel login-card">
        <h3 style="margin:0 0 10px 0">Sign in</h3>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@domain.com" autocomplete="username" />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px;">
          <button id="loginBtn" class="btn primary">üîê Sign in</button>
        </div>
        <div id="loginMsg" class="msg"></div>
      </div>
    </section>

    <!-- APP PAGE -->
    <section id="appPage" style="display:none;">
      <!-- Controls -->
      <div class="panel controls">
        <div class="controls-row">
          <div class="searchbar">
            <span class="icon">üîé</span>
            <input id="searchInput" type="search" placeholder="Search by title, author, category, or year‚Ä¶" />
          </div>
          <select id="categoryFilter" title="Filter by category"></select>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn primary" id="toggleFormBtn">‚ûï Add Book</button>
          <span id="authInfo" class="muted"></span>
          <button id="logoutBtn" class="btn ghost">üö™ Sign out</button>
        </div>
      </div>

      <!-- Add/Edit Book Form -->
      <div class="panel" id="formPanel" style="display:none;">
        <form id="bookForm" class="form" novalidate>
          <input type="hidden" id="editId" />
          <div class="grid-2">
            <div class="field">
              <label for="title">Title <span class="pill">Required</span></label>
              <input id="title" name="title" placeholder="e.g., Clean Code" required />
            </div>
            <div class="field">
              <label for="author">Author <span class="pill">Required</span></label>
              <input id="author" name="author" placeholder="e.g., Robert C. Martin" required />
            </div>
          </div>
          <div class="grid-2">
            <div class="field">
              <label for="category">Category</label>
              <input id="category" name="category" placeholder="e.g., Programming" />
            </div>
            <div class="field">
              <label for="year">Published Year</label>
              <input id="year" name="year" inputmode="numeric" pattern="\\d{4}" placeholder="e.g., 2008" />
            </div>
          </div>
          <div class="field">
            <label for="url">Book Downloadable URL <span class="pill">Required</span></label>
            <input id="url" name="url" placeholder="https://example.com/path/to/book.pdf" required />
            <div class="hint">The file is hosted elsewhere; we only store the link.</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn primary" type="submit" id="saveBtn">üíæ Save Book</button>
            <button class="btn" type="button" id="cancelForm">‚úñ Cancel</button>
          </div>
        </form>
      </div>

      <!-- List -->
      <div class="panel list" id="listPanel">
        <div class="empty" id="emptyState">No books yet. Add one to get started.</div>
        <div id="cards"></div>
        <!-- pager -->
        <div id="pager" class="pager" style="display:none;">
          <button id="prevPage" class="btn small">‚óÄ Prev</button>
          <span id="pageInfo" class="muted">Page 1</span>
          <button id="nextPage" class="btn small">Next ‚ñ∂</button>
        </div>
      </div>

      <div class="footer-note">Private app ‚Äî reads & writes require sign-in.</div>
    </section>
  </div>

<!-- Firebase (modular v11) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    signInWithEmailAndPassword, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, getDocs,
    query as fsQuery, orderBy, serverTimestamp, enableIndexedDbPersistence,
    where, startAt, endAt, limit, startAfter
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
       apiKey: "AIzaSyAX-EzgH83W61LhAfjkpAoM9f0LfAFyAdc",
       authDomain: "booklibrary-8eab9.firebaseapp.com",
       projectId: "booklibrary-8eab9",
       storageBucket: "booklibrary-8eab9.firebasestorage.app",
       messagingSenderId: "370524170249",
       appId: "1:370524170249:web:886ca9671202752e7370d8"
  };

  // ---- Init ----
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  enableIndexedDbPersistence(db).catch(()=>{});
  setPersistence(auth, browserLocalPersistence);

  // ---- Screen toggles ----
  const loginPage = document.getElementById("loginPage");
  const appPage   = document.getElementById("appPage");
  function showLogin(){ loginPage.style.display="grid"; appPage.style.display="none"; }
  function showApp(){   loginPage.style.display="none"; appPage.style.display="block"; }

  // ---- Auth ----
  const emailEl = document.getElementById("email");
  const passEl  = document.getElementById("password");
  const loginBtn= document.getElementById("loginBtn");
  const logoutBtn= document.getElementById("logoutBtn");
  const authInfo= document.getElementById("authInfo");
  const loginMsg= document.getElementById("loginMsg");

  function showError(msg){ loginMsg.className="msg error"; loginMsg.textContent=msg; loginMsg.style.display="block"; }

  loginBtn.addEventListener("click", async ()=>{
    try{
      loginMsg.style.display="none";
      const email = emailEl.value.trim();
      const pw = passEl.value;
      if(!email || !pw) return showError("Enter your email and password.");
      const { user } = await signInWithEmailAndPassword(auth, email, pw);
      passEl.value="";
      authInfo.textContent = `Signed in as ${user.email}`;
      showApp();
      await refreshAllCategories();      // NEW: load all categories once
      resetPagination();
      await runSearchHybrid();           // initial load
    }catch(e){ console.error(e); showError("Sign-in failed. Check your credentials or if the user exists in Firebase Auth."); }
  });

  logoutBtn.addEventListener("click", async ()=>{
    await signOut(auth);
    showLogin();
  });

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      authInfo.textContent = `Signed in as ${user.email}`;
      showApp();
      await refreshAllCategories();      // NEW
      resetPagination();
      await runSearchHybrid();
    }else{
      showLogin();
    }
  });

  // ---- State + pagination ----
  let allCategories = ["All"];           // NEW: cache of all categories
  let booksAll = [];                     // full set (client-paged modes)
  let booksPage = [];                    // current page to render
  let queryStr = "";
  let categoryFilter = "all";

  const PAGE_SIZE = 25;
  let page = 1;
  let modeKey = "";      // 'all+empty' | 'all+query' | 'category'
  let cursors = [];      // last doc of each server-paged page
  let hasNext = false;

  const $ = sel => document.querySelector(sel);
  function normalize(s){ return (s||"").toString().toLowerCase().trim(); }
  function escapeHtml(str){ return (str??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

  function containsMatch(book, q) {
    const s = (q || "").toLowerCase().trim();
    if (!s) return true;
    return [book.title, book.author, book.category, book.year]
      .some(v => (v ?? "").toString().toLowerCase().includes(s));
  }

  function resetPagination(){ page=1; cursors=[]; hasNext=false; }
  function setMode(key){ if (modeKey !== key){ modeKey=key; resetPagination(); } }

  function applyClientPaging(list){
    booksAll = list.slice();
    const total = booksAll.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (page > totalPages) page = totalPages;
    const start = (page - 1) * PAGE_SIZE;
    booksPage = booksAll.slice(start, start + PAGE_SIZE);
    hasNext = page < totalPages;
    updatePager({ total, totalPages, serverPaged:false });
  }

  function updatePager({ total=null, totalPages=null, serverPaged }){
    const pager = $("#pager");
    const info  = $("#pageInfo");
    const prevB = $("#prevPage");
    const nextB = $("#nextPage");
    pager.style.display = (serverPaged || booksAll.length > PAGE_SIZE || page>1) ? "flex" : "none";
    if (serverPaged){
      info.textContent = `Page ${page}`;
      prevB.disabled = (page === 1);
      nextB.disabled = !hasNext;
    } else {
      info.textContent = total != null ? `Page ${page} of ${totalPages} ‚Ä¢ ${total} results` : `Page ${page}`;
      prevB.disabled = (page === 1);
      nextB.disabled = !hasNext;
    }
  }

  $("#prevPage").addEventListener("click", async ()=>{
    if (page === 1) return;
    page--;
    await runSearchHybrid(true);
  });
  $("#nextPage").addEventListener("click", async ()=>{
    if (!hasNext) return;
    page++;
    await runSearchHybrid(true);
  });

  // ---- Load ALL categories once (for dropdown) ----
  async function refreshAllCategories(){
    const booksRef = collection(db, "books");
    // orderBy(categoryLower) ‚Üí full scan but small payload (only categories)
    const snap = await getDocs(fsQuery(booksRef, orderBy("categoryLower")));
    const set = new Set();
    snap.docs.forEach(d=>{
      const b = d.data();
      const c = (b.category || "").trim();
      if (c) set.add(c);  // keep original case for label
    });
    allCategories = ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
    renderCategoryDropdown();            // draw menu
  }

  function renderCategoryDropdown(){
    const sel = document.getElementById("categoryFilter");
    const prev = categoryFilter;         // lowercase like "all" or "fantasy"
    sel.innerHTML = allCategories.map(c=>{
      const val = c.toLowerCase();
      return `<option value="${val}">${c}</option>`;
    }).join("");
    sel.value = prev;
  }

  // ---- Hybrid search + pagination ----
  async function runSearchHybrid(preservePage=false){
    const q = normalize(queryStr);
    const catVal = categoryFilter;      // 'all' or category value (lowercase)
    const catLower = normalize(categoryFilter);
    const booksRef = collection(db, "books");

    const key = (catVal === "all") ? (q ? "all+query" : "all+empty") : "category";
    if (!preservePage) setMode(key); else modeKey = key;

    // 1) All + empty -> server-side paging
    if (modeKey === "all+empty"){
      let qRef = fsQuery(booksRef, orderBy("createdAt","desc"), limit(PAGE_SIZE));
      if (page > 1 && cursors[page-2]) {
        qRef = fsQuery(booksRef, orderBy("createdAt","desc"), startAfter(cursors[page-2]), limit(PAGE_SIZE));
      }
      const snap = await getDocs(qRef);
      const docs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      booksPage = docs;
      hasNext = docs.length === PAGE_SIZE;
      if (docs.length) cursors[page-1] = snap.docs[snap.docs.length - 1];
      booksAll = docs; // small cache for category badges rendering only
      renderCategoryDropdown();          // use ALL categories, not page-derived
      updatePager({ serverPaged:true });
      renderList();
      return;
    }

    // 2) Category selected -> fetch category, contains filter, client-page
    if (modeKey === "category"){
      const snap = await getDocs(fsQuery(booksRef, where("categoryLower","==", catLower)));
      const allInCat = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const filtered = allInCat
        .filter(b => containsMatch(b, q))
        .sort((a,b)=> (a.title||"").localeCompare(b.title||""));
      applyClientPaging(filtered);
      renderCategoryDropdown();
      renderList();
      return;
    }

    // 3) All + query -> prefix across fields, merge, client-page
    const start = q, end = q + "\uf8ff";
    const fetchPrefix = async (field) => {
      const snap = await getDocs(fsQuery(booksRef, orderBy(field), startAt(start), endAt(end)));
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    };
    const fields = ["titleLower", "authorLower", "yearStr"]; // skip categoryLower (redundant)
    const results = await Promise.all(fields.map(fetchPrefix));
    const dedup = new Map();
    results.flat().forEach(doc => dedup.set(doc.id, doc));
    const merged = Array.from(dedup.values())
      .sort((a,b)=> (a.title||"").localeCompare(b.title||""));
    applyClientPaging(merged);
    renderCategoryDropdown();
    renderList();
  }

  // ---- Render list
  function renderList(){
    const cardsEl = document.getElementById("cards");
    const emptyEl = document.getElementById("emptyState");
    const list = booksPage;
    cardsEl.innerHTML = "";
    emptyEl.style.display = list.length ? "none" : "block";
    list.forEach((b)=>{
      const card = document.createElement("div"); card.className="card";
      card.innerHTML = `
        <div class="meta">
          <div class="title-row">
            <div class="book-title">${escapeHtml(b.title)}</div>
            ${b.category ? `<span class="pill">${escapeHtml(b.category)}</span>` : ""}
          </div>
          <div class="muted">by ${escapeHtml(b.author)}${b.year?` ‚Ä¢ ${escapeHtml(b.year)}`:""}</div>
          <div class="muted"><a href="${b.url}" target="_blank" rel="noopener noreferrer">üìñ Book Link</a></div>
        </div>
        <div class="actions">
          <a class="btn small primary" href="${b.url}" target="_blank" rel="noopener noreferrer">‚¨á Download</a>
          <button class="btn small" data-action="copy" data-id="${b.id}">üìã Copy URL</button>
          <button class="btn small" data-action="edit" data-id="${b.id}">‚úèÔ∏è Edit</button>
          <button class="btn small" data-action="remove" data-id="${b.id}" title="Remove this book">üóë Remove</button>
        </div>`;
      cardsEl.appendChild(card);
    });
  }

  // ---- Inputs ‚Üí search (reset page)
  document.getElementById("searchInput").addEventListener("input",
    debounce(async e=>{ queryStr=e.target.value; resetPagination(); await runSearchHybrid(); }, 250));
  document.getElementById("categoryFilter").addEventListener("change",
    async e=>{ categoryFilter=e.target.value; resetPagination(); await runSearchHybrid(); });

  // ---- Add/Edit form
  const formPanel = document.getElementById("formPanel");
  const saveBtn   = document.getElementById("saveBtn");
  document.getElementById("toggleFormBtn").addEventListener("click", ()=>{
    enterCreateMode(); formPanel.style.display = "block";
  });
  document.getElementById("cancelForm").addEventListener("click", ()=>{
    document.getElementById("bookForm").reset(); enterCreateMode(); formPanel.style.display="none";
  });

  document.getElementById("bookForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const form = e.target;
    const editId = document.getElementById("editId").value || null;
    const title=form.title.value.trim(), author=form.author.value.trim(), category=form.category.value.trim();
    const year=form.year.value.trim(), url=form.url.value.trim();
    if(!title||!author||!url) return alert("Please fill Title, Author, and URL.");
    if(!/^https?:\/\//i.test(url) && !confirm("URL does not look like http(s). Save anyway?")) return;
    if(year && !/^\d{4}$/.test(year)) return alert("Year must be 4 digits (e.g., 2021) or leave blank.");

    const payload = {
      title, author, category, year, url,
      titleLower: title.toLowerCase(),
      authorLower: author.toLowerCase(),
      categoryLower: (category||"").toLowerCase(),
      yearStr: (year||"").toString().toLowerCase()
    };

    try{
      if(editId){
        await updateDoc(doc(db, "books", editId), { ...payload, updatedAt: serverTimestamp() });
      }else{
        await addDoc(collection(db, "books"), { ...payload, createdAt: serverTimestamp() });
      }
      form.reset(); enterCreateMode(); formPanel.style.display="none";
      await refreshAllCategories();      // NEW: refresh dropdown options after write
      resetPagination();
      await runSearchHybrid();
    }catch(err){ console.error(err); alert(editId ? "Update failed. Check permissions." : "Save failed. Check permissions."); }
  });

  function enterCreateMode(){
    document.getElementById("editId").value = "";
    saveBtn.textContent = "üíæ Save Book";
  }
  function enterEditMode(book){
    document.getElementById("editId").value = book.id;
    document.getElementById("title").value = book.title || "";
    document.getElementById("author").value = book.author || "";
    document.getElementById("category").value = book.category || "";
    document.getElementById("year").value = book.year || "";
    document.getElementById("url").value = book.url || "";
    saveBtn.textContent = "‚úÖ Update Book";
    formPanel.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Copy / Edit / Remove
  document.getElementById("cards").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button"); if(!btn) return;
    const action = btn.getAttribute("data-action"); const id = btn.getAttribute("data-id");
    const book = booksPage.find(b=>b.id===id) || booksAll.find(b=>b.id===id);
    if(!book) return;

    if(action==="copy"){
      try{ await navigator.clipboard.writeText(book.url); btn.textContent="‚úÖ Copied!"; setTimeout(()=>btn.textContent="üìã Copy URL",1200); }
      catch{ alert("Copy failed. You can select and copy the URL manually."); }
    }else if(action==="remove"){
      if(confirm(`Remove ‚Äú${book.title}‚Äù?`)){
        try{
          await deleteDoc(doc(db,"books",id));
          await refreshAllCategories();  // NEW: keep dropdown in sync after delete
          resetPagination();
          await runSearchHybrid();
        }catch(err){ console.error(err); alert("Delete failed. Check rules."); }
      }
    }else if(action==="edit"){
      enterEditMode(book);
    }
  });

  function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
</script>
</body>
</html>
